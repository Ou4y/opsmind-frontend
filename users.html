<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OpsMind Users - Admin User Management">
    <title>Users - OpsMind</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/assets/css/main.css" rel="stylesheet">

    <!-- Runtime config (must be before any app/service scripts) -->
    <script src="/assets/js/config.js"></script>
</head>
<body class="app-body">
    <!-- Navigation (loaded dynamically) -->
    <nav class="navbar-main" id="navbar-container"></nav>

    <div class="app-wrapper">
        <!-- Sidebar (loaded dynamically) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <h1 class="page-title">
                        <i class="bi bi-people me-2"></i>
                        User Management
                    </h1>
                    <p class="page-description">Manage system users and their permissions</p>
                </div>
                <div class="page-header-actions">
                    <button class="btn btn-outline-primary" id="exportUsersBtn">
                        <i class="bi bi-download me-2"></i>Export
                    </button>
                    <button class="btn btn-primary" id="createUserBtn">
                        <i class="bi bi-person-plus me-2"></i>Add User
                    </button>
                </div>
            </div>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-card-icon bg-primary">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="totalUsers">0</div>
                                <div class="stat-card-label">Total Users</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-card-icon bg-success">
                                <i class="bi bi-person-check"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeUsers">0</div>
                                <div class="stat-card-label">Active Users</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-card-icon bg-info">
                                <i class="bi bi-mortarboard"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="studentCount">0</div>
                                <div class="stat-card-label">Students</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-card-icon bg-warning">
                                <i class="bi bi-person-video3"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="professorCount">0</div>
                                <div class="stat-card-label">Professors</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Card -->
                <div class="card filter-card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="roleFilter">
                                    <option value="">All Roles</option>
                                    <option value="ADMIN">Administrator</option>
                                    <option value="DOCTOR">Professor</option>
                                    <option value="JUNIOR">Junior Technician</option>
                                    <option value="SENIOR">Senior Technician</option>
                                    <option value="SUPERVISOR">Supervisor</option>
                                    <option value="STUDENT">Student</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="true">Verified</option>
                                    <option value="false">Unverified</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" id="clearFilters">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table Card -->
                <div class="card">
                    <div class="card-body">
                        <!-- Loading State -->
                        <div id="usersLoading" class="text-center py-5 d-none">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Loading users...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="usersEmpty" class="empty-state d-none">
                            <i class="bi bi-people"></i>
                            <h3>No Users Found</h3>
                            <p>There are no users matching your criteria.</p>
                            <button class="btn btn-primary" id="createFirstUser">
                                <i class="bi bi-person-plus me-2"></i>Add First User
                            </button>
                        </div>

                        <!-- Error State -->
                        <div id="usersError" class="error-state d-none">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h3>Failed to Load Users</h3>
                            <p id="usersErrorMessage">An error occurred while loading users.</p>
                            <button class="btn btn-primary" id="retryLoadUsers">
                                <i class="bi bi-arrow-clockwise me-2"></i>Retry
                            </button>
                        </div>

                        <!-- Users Table -->
                        <div class="table-responsive" id="usersTableContainer">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="name">
                                            Name <i class="bi bi-chevron-expand"></i>
                                        </th>
                                        <th class="sortable" data-sort="email">
                                            Email <i class="bi bi-chevron-expand"></i>
                                        </th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th class="sortable" data-sort="created">
                                            Created <i class="bi bi-chevron-expand"></i>
                                        </th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Users pagination" id="usersPagination" class="d-none">
                            <ul class="pagination justify-content-center mb-0" id="paginationList">
                                <!-- Dynamic pagination -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">
                        <i class="bi bi-person-plus me-2"></i>
                        <span id="userModalTitle">Add New User</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="userForm" novalidate>
                    <div class="modal-body">
                        <input type="hidden" id="userId" name="userId">
                        
                        <!-- First Name -->
                        <div class="mb-3">
                            <label for="userFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userFirstName" required>
                            <div class="invalid-feedback">Please enter first name.</div>
                        </div>

                        <!-- Last Name -->
                        <div class="mb-3">
                            <label for="userLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userLastName" required>
                            <div class="invalid-feedback">Please enter last name.</div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                            <div class="invalid-feedback">Please enter a valid MIU email (@miuegypt.edu.eg).</div>
                            <small class="form-text text-muted">Must end with @miuegypt.edu.eg</small>
                        </div>

                        <!-- Password (only for create) -->
                        <div class="mb-3" id="passwordGroup">
                            <label for="userPassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="userPassword">
                            <div class="invalid-feedback">Password must be at least 8 characters with uppercase, lowercase, number, and special character.</div>
                            <small class="form-text text-muted">Min 8 chars, uppercase, lowercase, number, special char</small>
                        </div>

                        <!-- Role -->
                        <div class="mb-3">
                            <label for="userRoleSelect" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="userRoleSelect" name="role" required>
                                <option value="">Select Role</option>
                                <option value="ADMIN">Administrator</option>
                                <option value="DOCTOR">Professor</option>
                                <option value="JUNIOR">Junior Technician</option>
                                <option value="SENIOR">Senior Technician</option>
                                <option value="SUPERVISOR">Supervisor</option>
                                <option value="STUDENT">Student</option>
                            </select>
                            <div class="invalid-feedback">Please select a role.</div>
                        </div>

                        <!-- Verified Status (only for edit) -->
                        <div class="mb-3 d-none" id="verifiedGroup">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="userVerified">
                                <label class="form-check-label" for="userVerified">Email Verified</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveUserBtn">
                            <i class="bi bi-check-lg me-2"></i>
                            <span id="saveUserBtnText">Create User</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteUserModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Delete User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                    <p class="text-muted mb-0 mt-2">This action cannot be undone.</p>
                    <input type="hidden" id="deleteUserId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteUserBtn">
                        <i class="bi bi-trash me-2"></i>Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Sidebar Toggle -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var toggle = document.getElementById('sidebarToggle');
            var sidebar = document.getElementById('sidebar-container');
            var backdrop = document.getElementById('sidebarBackdrop');
            
            if (toggle && sidebar) {
                toggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                    if (backdrop) backdrop.classList.toggle('show');
                });
            }
            if (backdrop) {
                backdrop.addEventListener('click', function() {
                    sidebar?.classList.remove('show');
                    backdrop.classList.remove('show');
                });
            }
        });
    </script>
    <!-- App Module -->
    <script type="module" src="/assets/js/app.js"></script>
    <!-- Admin Access Check (runs before page loads) -->
    <script type="module">
        import AuthService from '/services/authService.js';
        
        // Immediately check if user is admin
        if (!AuthService.isAdmin()) {
            console.error('[Users Page] Unauthorized access attempt - user is not admin');
            sessionStorage.setItem('opsmind_error', '⚠️ Access Denied: This page requires administrator privileges.');
            window.location.href = 'dashboard.html';
        } else {
            console.log('[Users Page] Access granted - user is admin');
        }
    </script>
    <!-- Users Page Script -->
    <script type="module">
        import { initUsersPage } from '/assets/js/pages/users.js';
        document.addEventListener('DOMContentLoaded', initUsersPage);
    </script>
</body>
</html>
