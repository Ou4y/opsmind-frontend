<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory - OpsMind</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- PDF & QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="/assets/css/main.css" rel="stylesheet">
    <style>
        .timeline-item { border-left: 2px solid #e9ecef; padding-left: 20px; position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ""; position: absolute; width: 12px; height: 12px; background: #0d6efd; border-radius: 50%; left: -7px; top: 5px; }
        .qty-badge { font-size: 0.9rem; min-width: 40px; }
        .cursor-pointer { cursor: pointer; }
        .bulk-header { background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 12px 20px; }
        /* Specs styling */
        .spec-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #6c757d; }
        .spec-value { font-weight: 600; color: #212529; }
    </style>
</head>
<body class="app-body">
    
    <div class="app-wrapper">
        <aside class="sidebar" id="sidebar-container">
            <div class="p-3 text-white">
                <h4 class="fw-bold"><i class="bi bi-box-seam me-2"></i>OpsMind</h4>
            </div>
            <nav class="nav flex-column mt-3">
                <a href="dashboard.html" class="nav-link text-white-50"><i class="bi bi-grid me-2"></i> Dashboard</a>
                <a href="inventory.html" class="nav-link active text-white bg-primary rounded mx-2"><i class="bi bi-box-seam me-2"></i> Assets</a>
            </nav>
        </aside>

        <main class="main-content w-100 p-4" style="margin-left: 260px;"> 
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h3 fw-bold mb-1">University Inventory</h2>
                    <p class="text-muted small mb-0">Grouped View</p>
                </div>
                
                <div class="d-flex gap-2 align-items-start">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search Name or ID..." onkeyup="filterGroupTable()" onkeypress="handleSearchKeyPress(event)">
                    </div>

                    <a href="print_labels.html" target="_blank" class="btn btn-outline-dark mb-3">
                        <i class="bi bi-qr-code"></i> Print Labels
                    </a>

                    <button class="btn btn-outline-success mb-3" onclick="exportAssetsToDetailedPDF()">
                        <i class="bi bi-file-pdf"></i> Export PDF with QR & Specs
                    </button>

                    <button class="btn btn-primary btn-sm d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#receiveOrderModal" style="height: 38px;">
                        <i class="bi bi-plus-lg"></i> Create Asset
                    </button>
                </div>
            </div>

            <div class="card border-0 bg-light mb-4">
                <div class="card-body py-3">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <span class="fw-bold text-muted small"><i class="bi bi-funnel-fill me-1"></i> FILTERS:</span>
                        </div>
                        <div class="col-md-3">
                            <select id="filterBuilding" class="form-select form-select-sm" onchange="syncFilters()">
                                <option value="all">All Buildings</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="filterDept" class="form-select form-select-sm" onchange="syncFilters()">
                                <option value="all">All Departments</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="filterType" class="form-select form-select-sm" onchange="syncFilters()">
                                <option value="all">All Asset Types</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card border shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="groupTable">
                            <thead class="bg-light">
                                <tr class="text-uppercase small text-muted">
                                    <th class="ps-4 py-3">Asset Name</th>
                                    <th>Type</th>
                                    <th>Total Quantity</th>
                                    <th>Locations Found</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="receiveOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Create New Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAssetForm">
                        <input type="text" id="assetName" placeholder="Asset Name (e.g. Dell Latitude 5420)" class="form-control mb-2" required />
                        <input type="number" id="assetQuantity" placeholder="Quantity" class="form-control mb-2" min="1" required />
                        
                        <select id="assetType" class="form-select mb-2" required>
                            <option value="">Select Asset Type</option>
                            <optgroup label="IT & Computing">
                                <option value="Laptop">Laptop</option>
                                <option value="Desktop">Desktop</option>
                                <option value="Tablet">Tablet</option>
                                <option value="Server">Server</option>
                                <option value="Monitor">Monitor</option>
                                <option value="Keyboard">Keyboard</option>
                                <option value="Peripheral">Peripheral</option>
                                <option value="Electronics">Electronics</option>
                            </optgroup>
                            <optgroup label="Office & Furniture">
                                <option value="Printer">Printer</option>
                                <option value="Scanner">Scanner</option>
                                <option value="Desk">Desk</option>
                                <option value="Chair">Chair</option>
                                <option value="Whiteboard">Whiteboard</option>
                                <option value="Filing_Cabinet">Filing Cabinet</option>
                                <option value="Furniture">Furniture</option>
                            </optgroup>
                        </select>

                        <div class="mb-2">
                            <label class="form-label small fw-bold">Technical Specs (Optional)</label>
                            <textarea id="assetSpecs" class="form-control" rows="3" placeholder="RAM: 16GB&#10;Processor: i7-12th Gen&#10;Storage: 512GB SSD"></textarea>
                            <div class="form-text small">Enter one spec per line (Key: Value)</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Create Assets</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editSpecsModal" tabindex="-1" aria-hidden="true" style="z-index: 1080;">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Edit Technical Specs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-secondary py-2 mb-3 small">
                        Editing: <strong id="editSpecAssetId">---</strong>
                    </div>
                    <form id="editSpecsForm">
                        <input type="hidden" id="editSpecTargetId">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Specifications (Key: Value)</label>
                            <textarea id="editSpecTextArea" class="form-control font-monospace" rows="6" placeholder="RAM: 16GB&#10;Processor: i7-12th Gen"></textarea>
                            <div class="form-text small">Update details one per line. Format: <strong>Key: Value</strong></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSpecsBtn" onclick="saveUpdatedSpecs()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="specModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-cpu me-2"></i>Asset Specifications</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="specTargetHeader" class="mb-3 p-3 bg-light rounded border">
                        </div>
                    <div id="specContent" class="list-group list-group-flush">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title fw-bold" id="detailModalTitle">Asset Details</h5>
                        <small class="text-muted">Manage individual items</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="bulk-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div class="input-group input-group-sm" style="max-width: 300px;">
                        <span class="input-group-text bg-white"><i class="bi bi-filter"></i></span>
                        <input type="text" id="innerSearchInput" class="form-control" placeholder="Filter IDs in this group..." onkeyup="filterDetailsTable()">
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-warning" id="bulkTransferBtn"><i class="bi bi-truck me-1"></i> Bulk Transfer</button>
                        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn"><i class="bi bi-trash-fill me-1"></i> Bulk Delete Group</button>
                    </div>
                </div>

                <div class="modal-body p-0">
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="ps-4">Unique ID</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Department</th>
                                    <th class="text-end pe-4">Individual Actions</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Transfer Asset(s)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3 small">
                        Targeting: <strong id="transferAssetId">---</strong>
                    </div>
                    <form id="transferForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Destination Type:</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="destType" id="radioBuilding" value="building" checked onchange="updateLocationOptions()">
                                <label class="btn btn-outline-primary" for="radioBuilding">Building</label>
                                <input type="radio" class="btn-check" name="destType" id="radioDept" value="department" onchange="updateLocationOptions()">
                                <label class="btn btn-outline-primary" for="radioDept">Dept</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Select Destination:</label>
                            <select class="form-select" id="locationSelect" required></select>
                        </div>

                        <div class="mb-3" id="qtyTransferWrapper">
                            <label class="form-label fw-bold">Quantity to Move:</label>
                            <input type="number" id="transferQty" class="form-control" value="1" min="1">
                            <div class="form-text text-muted small">Max available: <span id="maxTransferQty">0</span></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn" onclick="submitTransfer()">Confirm Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Audit Trail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyContent" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = 'http://localhost:3002/api';
        let allAssets = []; 
        let groupedAssets = {}; 
        let transferQueue = [];

        // Backend Constants
        const BUILDINGS = [
            'Central Warehouse', 
            'Main Building', 
            'K Building', 
            'N Building', 
            'S Building', 
            'R Building', 
            'Pharmacy Building'
        ];

        const DEPARTMENTS = [
            'Computer Science', 
            'Engineering', 
            'Architecture', 
            'Business', 
            'Mass Comm', 
            'Alsun', 
            'Pharmacy', 
            'Dentistry', 
            'Unassigned'
        ];

        const ASSET_TYPES = [
            // IT & Computing
            { value: 'laptop', label: 'Laptop', category: 'IT & Computing' },
            { value: 'desktop', label: 'Desktop PC', category: 'IT & Computing' },
            { value: 'monitor', label: 'Monitor', category: 'IT & Computing' },
            { value: 'server', label: 'Server', category: 'IT & Computing' },
            { value: 'tablet', label: 'Tablet / iPad', category: 'IT & Computing' },
            { value: 'peripheral', label: 'Peripheral (Keyboard/Mouse)', category: 'IT & Computing' },
            
            // AV & Classroom
            { value: 'projector', label: 'Projector', category: 'AV & Classroom' },
            { value: 'smartboard', label: 'Smartboard', category: 'AV & Classroom' },
            { value: 'camera', label: 'Camera', category: 'AV & Classroom' },
            { value: 'microphone', label: 'Microphone', category: 'AV & Classroom' },
            { value: 'speaker', label: 'Speaker System', category: 'AV & Classroom' },

            // Networking
            { value: 'router', label: 'Router', category: 'Networking' },
            { value: 'switch', label: 'Network Switch', category: 'Networking' },
            { value: 'access_point', label: 'Access Point (WiFi)', category: 'Networking' },
            { value: 'firewall', label: 'Firewall Appliance', category: 'Networking' },

            // Office & Furniture
            { value: 'printer', label: 'Printer', category: 'Office & Furniture' },
            { value: 'scanner', label: 'Scanner', category: 'Office & Furniture' },
            { value: 'desk', label: 'Desk', category: 'Office & Furniture' },
            { value: 'chair', label: 'Chair', category: 'Office & Furniture' },
            { value: 'filing_cabinet', label: 'Filing Cabinet', category: 'Office & Furniture' },
            { value: 'whiteboard', label: 'Whiteboard', category: 'Office & Furniture' },

            // Lab & Research
            { value: 'microscope', label: 'Microscope', category: 'Lab & Research' },
            { value: 'centrifuge', label: 'Centrifuge', category: 'Lab & Research' },
            { value: 'oscilloscope', label: 'Oscilloscope', category: 'Lab & Research' },
            { value: '3d_printer', label: '3D Printer', category: 'Lab & Research' },

            // Facilities
            { value: 'vehicle', label: 'University Vehicle', category: 'Facilities' },
            { value: 'generator', label: 'Generator', category: 'Facilities' },
            { value: 'hvac', label: 'HVAC Unit', category: 'Facilities' },
            { value: 'maintenance_tool', label: 'Power Tool', category: 'Facilities' },
        ];

        const universityData = {
            building: BUILDINGS,
            department: DEPARTMENTS
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchAssets();
            document.getElementById('createAssetForm').addEventListener('submit', handleCreateAsset);
            updateLocationOptions(); 

            // QR & Direct Search Logic
            const urlParams = new URLSearchParams(window.location.search);
            const idFromQR = urlParams.get('id');
            if (idFromQR) {
                setTimeout(() => showAssetSpecs(idFromQR), 600);
            }
        });

        async function fetchAssets() {
            try {
                const res = await fetch(`${API_URL}/assets`);
                allAssets = await res.json();
                
                // ✅ Initialize Filters once data is loaded
                initFilters();
                
                groupAssets(); // Group all initially
                renderGroupTable();
            } catch (err) {
                console.error(err);
            }
        }

        /* ----------------------------------------------------
           ✅ NEW FILTER LOGIC START
           ---------------------------------------------------- */
        
        function initFilters() {
            // Use the predefined constants to ensure ALL options are always available
            // regardless of what's in the database
            
            // Initialize Building Dropdown
            const bldgSelect = document.getElementById('filterBuilding');
            bldgSelect.innerHTML = '<option value="all">All Buildings</option>';
            BUILDINGS.forEach(b => {
                bldgSelect.innerHTML += `<option value="${b}">${b}</option>`;
            });

            // Initialize Department Dropdown
            const deptSelect = document.getElementById('filterDept');
            deptSelect.innerHTML = '<option value="all">All Departments</option>';
            DEPARTMENTS.forEach(d => {
                deptSelect.innerHTML += `<option value="${d}">${d}</option>`;
            });

            // Initialize Asset Type Dropdown with Categories
            const typeSelect = document.getElementById('filterType');
            typeSelect.innerHTML = '<option value="all">All Asset Types</option>';
            
            // Group asset types by category
            const categories = {};
            ASSET_TYPES.forEach(t => {
                if (!categories[t.category]) {
                    categories[t.category] = [];
                }
                categories[t.category].push(t);
            });
            
            // Create optgroups for each category
            Object.keys(categories).sort().forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                categories[category].forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.value;
                    option.textContent = t.label;
                    optgroup.appendChild(option);
                });
                typeSelect.appendChild(optgroup);
            });
        }

        // Synchronized Filter Logic - triggered by any filter change
        function syncFilters() {
            const bldg = document.getElementById('filterBuilding').value;
            const dept = document.getElementById('filterDept').value;
            const type = document.getElementById('filterType').value;

            // Filter assets based on all three criteria
            const filteredAssets = allAssets.filter(asset => {
                const matchBldg = (bldg === 'all') || (asset.location === bldg);
                const matchDept = (dept === 'all') || (asset.department === dept);
                const matchType = (type === 'all') || (asset.type === type);
                return matchBldg && matchDept && matchType;
            });

            groupAssets(filteredAssets); // Group the filtered subset
            renderGroupTable();
        }

        function resetFilters() {
            document.getElementById('filterBuilding').value = 'all';
            document.getElementById('filterDept').value = 'all';
            document.getElementById('filterType').value = 'all';
            
            // Show all data
            groupAssets(allAssets);
            renderGroupTable();
        }

        /* ----------------------------------------------------
           ✅ END NEW FILTER LOGIC
           ---------------------------------------------------- */

        // Search bar Enter key handler
        function handleSearchKeyPress(e) {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query.length > 5) {
                    showAssetSpecs(query);
                }
            }
        }

        // Show Specifications for a single item
        async function showAssetSpecs(customId) {
            try {
                const res = await fetch(`${API_URL}/assets/single/${customId}`);
                if (!res.ok) throw new Error("Asset not found");
                
                const asset = await res.json();
                
                document.getElementById('specTargetHeader').innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 fw-bold">${asset.name}</h5>
                            <span class="badge bg-secondary small">${asset.customId}</span>
                        </div>
                        <div class="text-end">
                            <span class="d-block small text-muted">Status:</span>
                            <span class="badge ${asset.status === 'active' ? 'bg-success' : 'bg-warning'}">${asset.status}</span>
                        </div>
                    </div>
                `;

                const container = document.getElementById('specContent');
                if (!asset.specifications || Object.keys(asset.specifications).length === 0) {
                    container.innerHTML = `<div class="py-4 text-center text-muted small"><i class="bi bi-info-circle mb-2 d-block h4"></i> No technical specs recorded.</div>`;
                } else {
                    container.innerHTML = Object.entries(asset.specifications).map(([key, value]) => `
                        <div class="list-group-item d-flex justify-content-between py-2 border-bottom">
                            <span class="spec-label">${key.replace(/_/g, ' ')}</span>
                            <span class="spec-value">${value}</span>
                        </div>
                    `).join('');
                }
                
                new bootstrap.Modal(document.getElementById('specModal')).show();
            } catch (err) {
                console.error(err);
                alert("Search Error: " + err.message);
            }
        }

        // ✅ MODIFIED: Accepts 'sourceData' to support filtering
        function groupAssets(sourceData = allAssets) {
            groupedAssets = {};
            sourceData.forEach(asset => {
                const key = asset.name; 
                if (!groupedAssets[key]) {
                    groupedAssets[key] = {
                        name: asset.name,
                        type: asset.type,
                        items: [],
                        locations: new Set()
                    };
                }
                groupedAssets[key].items.push(asset);
                groupedAssets[key].locations.add(asset.location);
            });
        }

        function renderGroupTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            // Handle Empty State
            if (Object.keys(groupedAssets).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No assets match your filters.</td></tr>';
                return;
            }

            Object.values(groupedAssets).forEach(group => {
                const locs = Array.from(group.locations).join(", ");
                const safeName = encodeURIComponent(group.name);
                tbody.innerHTML += `
                    <tr data-group-name="${group.name}">
                        <td class="ps-4 fw-bold cursor-pointer" onclick="showAssetSpecs('${group.items[0].customId}')">${group.name}</td>
                        <td class="text-muted text-uppercase small">${group.type}</td>
                        <td><span class="badge bg-primary rounded-pill qty-badge">${group.items.length}</span></td>
                        <td class="small text-muted text-truncate" style="max-width: 200px;">${locs}</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <a href="print_labels.html?name=${safeName}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="bi bi-printer"></i></a>
                                <button class="btn btn-sm btn-outline-primary" onclick="openDetailsModal('${safeName}')"><i class="bi bi-list-ul"></i> View Items</button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function filterGroupTable() {
            const input = document.getElementById("searchInput").value.toUpperCase();
            const rows = document.getElementById("inventoryTableBody").getElementsByTagName("tr");
            for (let row of rows) {
                row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
            }
        }

        function filterDetailsTable() {
            const input = document.getElementById("innerSearchInput").value.toUpperCase();
            const rows = document.getElementById("detailsTableBody").getElementsByTagName("tr");
            for (let row of rows) {
                row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
            }
        }

        function openDetailsModal(encodedName) {
            const groupName = decodeURIComponent(encodedName);
            const group = groupedAssets[groupName];
            if (!group) return;

            document.getElementById('innerSearchInput').value = '';
            const tbody = document.getElementById('detailsTableBody');
            document.getElementById('detailModalTitle').innerText = `${group.name} (${group.items.length} items)`;
            tbody.innerHTML = '';

            document.getElementById('bulkDeleteBtn').onclick = () => bulkDelete(group.items);
            document.getElementById('bulkTransferBtn').onclick = () => openTransferModal(group.items.map(i => i.customId));

            group.items.forEach(asset => {
                const historyData = encodeURIComponent(JSON.stringify(asset.history || []));
                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 font-monospace fw-bold text-dark cursor-pointer" onclick="showAssetSpecs('${asset.customId}')">${asset.customId}</td>
                        <td><span class="badge ${asset.status === 'active' ? 'bg-success' : 'bg-warning'}">${asset.status || 'Active'}</span></td>
                        <td>${asset.location}</td>
                        <td>${asset.department}</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditSpecsModal('${asset.customId}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <a href="print_labels.html?id=${asset.customId}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="bi bi-qr-code"></i></a>
                                <button class="btn btn-sm btn-outline-info" onclick="viewHistory('${historyData}')"><i class="bi bi-clock-history"></i></button>
                                <button class="btn btn-sm btn-outline-warning" onclick="openTransferModal(['${asset.customId}'])"><i class="bi bi-arrow-left-right"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAsset('${asset._id}')"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        /**
         * Logic for Editing Specifications
         */
        async function openEditSpecsModal(customId) {
            try {
                const res = await fetch(`${API_URL}/assets/single/${customId}`);
                if (!res.ok) throw new Error("Could not fetch asset details");
                const asset = await res.json();

                document.getElementById('editSpecAssetId').innerText = asset.customId;
                document.getElementById('editSpecTargetId').value = asset.customId;

                const specsString = asset.specifications 
                    ? Object.entries(asset.specifications).map(([k, v]) => `${k}: ${v}`).join('\n') 
                    : "";
                
                document.getElementById('editSpecTextArea').value = specsString;

                const editModal = new bootstrap.Modal(document.getElementById('editSpecsModal'));
                editModal.show();
            } catch (err) {
                alert("Error loading specifications: " + err.message);
            }
        }

        async function saveUpdatedSpecs() {
            const customId = document.getElementById('editSpecTargetId').value;
            const specText = document.getElementById('editSpecTextArea').value;
            const saveBtn = document.getElementById('saveSpecsBtn');

            const specsObj = {};
            specText.split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const k = parts.shift().trim();
                    const v = parts.join(':').trim();
                    if (k) specsObj[k] = v;
                }
            });

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            try {
                const res = await fetch(`${API_URL}/assets/${customId}/details`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ specifications: specsObj })
                });

                if (res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editSpecsModal')).hide();
                    await fetchAssets();
                    alert("Specifications updated successfully!");
                } else {
                    throw new Error("Server failed to update specifications.");
                }
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = 'Save Changes';
            }
        }

        async function handleCreateAsset(e) {
            e.preventDefault();
            const name = document.getElementById('assetName').value;
            const type = document.getElementById('assetType').value;
            const quantity = parseInt(document.getElementById('assetQuantity').value);
            
            const specText = document.getElementById('assetSpecs').value;
            const specsObj = {};
            specText.split('\n').forEach(line => {
                const [k, v] = line.split(':');
                if (k && v) specsObj[k.trim()] = v.trim();
            });

            try {
                const res = await fetch(`${API_URL}/assets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name, type, quantity,
                        specifications: specsObj,
                        location: 'Central Warehouse', department: 'Unassigned'
                    })
                });
                if (res.ok) {
                    location.reload();
                } else {
                    alert("Creation failed on server.");
                }
            } catch (err) { alert("Network error."); }
        }

        function updateLocationOptions() {
            const type = document.querySelector('input[name="destType"]:checked').value;
            const select = document.getElementById('locationSelect');
            select.innerHTML = '';
            universityData[type].forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc;
                opt.textContent = loc;
                select.appendChild(opt);
            });
        }

        function openTransferModal(ids) {
            transferQueue = ids;
            const qtyInput = document.getElementById('transferQty');
            qtyInput.value = 1;
            qtyInput.max = ids.length;
            document.getElementById('maxTransferQty').innerText = ids.length;
            
            document.getElementById('qtyTransferWrapper').style.display = ids.length > 1 ? 'block' : 'none';
            document.getElementById('transferAssetId').innerText = ids.length === 1 ? ids[0] : `${ids.length} items`;
            
            const modalEl = document.getElementById('transferModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }

        async function submitTransfer() {
            const confirmBtn = document.getElementById('confirmTransferBtn');
            const destType = document.querySelector('input[name="destType"]:checked').value;
            const destination = document.getElementById('locationSelect').value;
            const qtyToMove = parseInt(document.getElementById('transferQty').value) || 1;
            
            if (!transferQueue.length) return;

            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            const targets = transferQueue.slice(0, qtyToMove);

            try {
                const promises = targets.map(id => 
                    fetch(`${API_URL}/assets/${id}/transfer`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ destType, destination, quantityToMove: 1 })
                    })
                );

                const results = await Promise.all(promises);
                if (results.every(r => r.ok)) {
                    await fetchAssets();
                    bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
                    const detMod = bootstrap.Modal.getInstance(document.getElementById('detailsModal'));
                    if (detMod) detMod.hide();
                } else {
                    throw new Error("Transfers failed.");
                }
            } catch (err) { 
                alert("Transfer failed."); 
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerText = 'Confirm Transfer';
            }
        }

        async function bulkDelete(items) {
            if(!confirm(`Delete ALL ${items.length} items?`)) return;
            const promises = items.map(item => fetch(`${API_URL}/assets/${item._id}`, { method: 'DELETE' }));
            await Promise.all(promises);
            location.reload();
        }

        async function deleteAsset(dbId) {
            if(!confirm("Are you sure?")) return;
            await fetch(`${API_URL}/assets/${dbId}`, { method: 'DELETE' });
            location.reload();
        }

        function viewHistory(encodedHistory) {
            try {
                const history = JSON.parse(decodeURIComponent(encodedHistory));
                const container = document.getElementById('historyContent');
                
                if (!history || !Array.isArray(history) || history.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted py-3">No history recorded.</p>';
                    new bootstrap.Modal(document.getElementById('historyModal')).show();
                    return;
                }
                
                // Reverse to show newest first
                const sortedHistory = history.reverse();
                
                container.innerHTML = sortedHistory.map(h => {
                    // Handle different history formats
                    let action = h.action || h.type;
                    const details = h.details || h.description || '';
                    
                    // If no action but we have details, use details as action with proper format
                    if (!action && details) {
                        // Capitalize first letter and format as action
                        action = details.charAt(0).toUpperCase() + details.slice(1);
                    } else if (!action) {
                        action = 'Successful Transfer';
                    }
                    
                    const timestamp = h.timestamp || h.date || h.createdAt;
                    
                    let dateStr = 'Invalid Date';
                    if (timestamp) {
                        const date = new Date(timestamp);
                        if (!isNaN(date.getTime())) {
                            dateStr = date.toLocaleString();
                        }
                    }
                    
                    return `
                        <div class="timeline-item">
                            <p class="mb-1 fw-bold text-dark">${action}</p>
                            <p class="mb-0 text-muted small">${dateStr}</p>
                        </div>
                    `;
                }).join('');
                
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            } catch (error) {
                console.error('Error parsing history:', error);
                const container = document.getElementById('historyContent');
                container.innerHTML = '<p class="text-center text-danger py-3">Error loading history data.</p>';
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            }
        }

        function formatType(type) {
            if (!type) return 'Unknown';
            return type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // Export all assets to detailed PDF with QR codes and specs
        async function exportAssetsToDetailedPDF() {
            const exportBtn = event.target.closest('button');
            const originalText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';

            try {
                // Create a temporary container for QR code rendering
                const tempQRContainer = document.createElement('div');
                tempQRContainer.style.display = 'none';
                document.body.appendChild(tempQRContainer);

                // Generate all QR codes in parallel
                const qrDataUrls = {};
                const qrPromises = allAssets.map((asset, index) => {
                    return new Promise((resolve) => {
                        const tempQR = document.createElement('div');
                        tempQR.id = `temp-qr-${index}`;
                        tempQRContainer.appendChild(tempQR);

                        try {
                            new QRCode(tempQR, {
                                text: `${asset.customId}`,
                                width: 100,
                                height: 100,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H,
                                onRenderingEnd: () => {
                                    const canvas = tempQR.querySelector('canvas');
                                    if (canvas) {
                                        qrDataUrls[index] = canvas.toDataURL('image/png');
                                    }
                                    resolve();
                                }
                            });
                            // Timeout after 3 seconds
                            setTimeout(() => resolve(), 3000);
                        } catch (e) {
                            console.error('QR code error:', e);
                            resolve();
                        }
                    });
                });

                // Wait for all QR codes to generate in parallel
                await Promise.all(qrPromises);

                // Now create the PDF content
                const container = document.createElement('div');
                container.style.backgroundColor = 'white';
                container.style.padding = '30px';
                container.style.fontFamily = 'Arial, sans-serif';
                container.style.lineHeight = '1.4';
                
                // Add title
                const title = document.createElement('h1');
                title.style.textAlign = 'center';
                title.style.marginBottom = '10px';
                title.style.fontSize = '26px';
                title.style.fontWeight = 'bold';
                title.innerText = 'University Asset Inventory Report';
                container.appendChild(title);

                // Add metadata
                const metadata = document.createElement('div');
                metadata.style.textAlign = 'center';
                metadata.style.marginBottom = '30px';
                metadata.style.color = '#666';
                metadata.style.fontSize = '12px';
                metadata.style.borderBottom = '2px solid #000';
                metadata.style.paddingBottom = '15px';
                metadata.innerHTML = `<p style="margin: 5px;">Generated on: ${new Date().toLocaleString()}</p><p style="margin: 5px;">Total Assets: ${allAssets.length}</p>`;
                container.appendChild(metadata);

                // Create asset cards grid
                const assetsGrid = document.createElement('div');
                assetsGrid.style.display = 'grid';
                assetsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
                assetsGrid.style.gap = '20px';
                assetsGrid.style.marginTop = '20px';

                allAssets.forEach((asset, index) => {
                    const card = document.createElement('div');
                    card.style.border = '1px solid #999';
                    card.style.padding = '12px';
                    card.style.borderRadius = '4px';
                    card.style.pageBreakInside = 'avoid';
                    card.style.backgroundColor = '#f5f5f5';

                    // Asset Name
                    const name = document.createElement('h3');
                    name.style.fontSize = '13px';
                    name.style.fontWeight = 'bold';
                    name.style.margin = '0 0 8px 0';
                    name.style.color = '#000';
                    name.innerText = asset.name;
                    card.appendChild(name);

                    // QR Code as Image
                    if (qrDataUrls[index]) {
                        const qrImg = document.createElement('img');
                        qrImg.src = qrDataUrls[index];
                        qrImg.style.width = '80px';
                        qrImg.style.height = '80px';
                        qrImg.style.display = 'block';
                        qrImg.style.margin = '8px auto';
                        qrImg.style.border = '1px solid #ccc';
                        card.appendChild(qrImg);
                    }

                    // Custom ID
                    const idLabel = document.createElement('p');
                    idLabel.style.fontSize = '10px';
                    idLabel.style.margin = '5px 0';
                    idLabel.innerHTML = `<strong>ID:</strong> ${asset.customId}`;
                    card.appendChild(idLabel);

                    // Type
                    const typeLabel = document.createElement('p');
                    typeLabel.style.fontSize = '10px';
                    typeLabel.style.margin = '3px 0';
                    typeLabel.innerHTML = `<strong>Type:</strong> ${formatType(asset.type)}`;
                    card.appendChild(typeLabel);

                    // Location
                    const locationLabel = document.createElement('p');
                    locationLabel.style.fontSize = '10px';
                    locationLabel.style.margin = '3px 0';
                    locationLabel.innerHTML = `<strong>Location:</strong> ${asset.location || 'N/A'}`;
                    card.appendChild(locationLabel);

                    // Department
                    const deptLabel = document.createElement('p');
                    deptLabel.style.fontSize = '10px';
                    deptLabel.style.margin = '3px 0';
                    deptLabel.innerHTML = `<strong>Department:</strong> ${asset.department || 'N/A'}`;
                    card.appendChild(deptLabel);

                    // Status
                    const statusLabel = document.createElement('p');
                    statusLabel.style.fontSize = '10px';
                    statusLabel.style.margin = '3px 0';
                    statusLabel.innerHTML = `<strong>Status:</strong> ${capitalize(asset.status || 'Available')}`;
                    card.appendChild(statusLabel);

                    // Specifications
                    if (asset.specifications && Object.keys(asset.specifications).length > 0) {
                        const specsLabel = document.createElement('p');
                        specsLabel.style.fontSize = '10px';
                        specsLabel.style.margin = '8px 0 3px 0';
                        specsLabel.style.fontWeight = 'bold';
                        specsLabel.innerHTML = 'Specifications:';
                        card.appendChild(specsLabel);

                        const specsList = document.createElement('ul');
                        specsList.style.fontSize = '9px';
                        specsList.style.margin = '0';
                        specsList.style.paddingLeft = '18px';

                        Object.entries(asset.specifications).forEach(([key, value]) => {
                            const specItem = document.createElement('li');
                            specItem.style.margin = '1px 0';
                            specItem.innerHTML = `${key}: ${value}`;
                            specsList.appendChild(specItem);
                        });
                        card.appendChild(specsList);
                    }

                    // Assigned User
                    if (asset.assignedUser) {
                        const userLabel = document.createElement('p');
                        userLabel.style.fontSize = '10px';
                        userLabel.style.margin = '5px 0 0 0';
                        userLabel.innerHTML = `<strong>Assigned To:</strong> ${asset.assignedUser}`;
                        card.appendChild(userLabel);
                    }

                    assetsGrid.appendChild(card);
                });

                container.appendChild(assetsGrid);

                // Generate PDF with html2pdf
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `University_Asset_Inventory_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 1.5, backgroundColor: '#ffffff', logging: false, useCORS: true },
                    jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                await html2pdf().set(opt).from(container).save();

                alert('PDF exported successfully!');
                
                // Clean up
                document.body.removeChild(tempQRContainer);
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error exporting PDF: ' + error.message);
                
                // Clean up if error occurs
                const qrTemp = document.querySelector('[id^="temp-qr-"]')?.parentElement;
                if (qrTemp) try { document.body.removeChild(qrTemp); } catch(e) {}
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
    <!-- Inventory Access Check -->
    <script type="module">
        import AuthService from '/services/authService.js';

        // Block access unless user is admin or technician
        if (!AuthService.isAuthenticated() || !(AuthService.isAdmin() || AuthService.isTechnician())) {
            console.error('[Inventory] Unauthorized access - redirecting');
            sessionStorage.setItem('opsmind_error', '⚠️ Access Denied: Admin or Technician required to access Inventory.');
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
