<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OpsMind AI Insights - SLA Breach Predictions">
    <title>AI Insights - OpsMind</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/assets/css/main.css" rel="stylesheet">

    <!-- Runtime config (must be before any app/service scripts) -->
    <script src="/assets/js/config.js"></script>
</head>
<body class="app-body">
    <!-- Navigation (loaded dynamically) -->
    <nav class="navbar-main" id="navbar-container"></nav>

    <div class="app-wrapper">
        <!-- Sidebar (loaded dynamically) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <h1 class="page-title">
                        <i class="bi bi-robot me-2"></i>AI Insights
                    </h1>
                    <p class="page-subtitle">Analyze tickets with AI-powered SLA breach predictions</p>
                </div>
            </div>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Info Card -->
                <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                    <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                    <div>
                        Click the <strong>"Analyze"</strong> button next to any ticket to get AI-powered SLA breach predictions. Your feedback helps improve our AI models.
                    </div>
                </div>

                <!-- Tickets Table Card -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-ticket-detailed me-2"></i>
                                <span id="ticketCount">All Tickets</span>
                            </h5>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Table View -->
                        <div class="table-responsive" id="tableView">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>Subject</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th class="text-end">AI Analysis</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketsTableBody">
                                    <!-- Loading skeleton rows -->
                                    <tr class="loading-row">
                                        <td colspan="6">
                                            <div class="d-flex justify-content-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading tickets...</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div class="empty-state d-none" id="ticketsEmpty">
                            <i class="bi bi-inbox"></i>
                            <h4>No Tickets Found</h4>
                            <p>There are no tickets to analyze.</p>
                        </div>

                        <!-- Error State -->
                        <div class="error-state d-none" id="ticketsError">
                            <i class="bi bi-exclamation-circle"></i>
                            <h4>Unable to Load Tickets</h4>
                            <p id="ticketsErrorMessage">An error occurred while loading tickets.</p>
                            <button class="btn btn-primary" id="retryLoadTickets">
                                <i class="bi bi-arrow-clockwise me-1"></i> Try Again
                            </button>
                        </div>
                    </div>
                    <div class="card-footer" id="ticketsPagination">
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="pagination-info">
                                Showing <span id="showingFrom">1</span> to <span id="showingTo">10</span> of <span id="totalTickets">0</span> tickets
                            </div>
                            <nav aria-label="Tickets pagination">
                                <ul class="pagination pagination-sm mb-0" id="paginationList">
                                    <!-- Pagination will be rendered here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="aiAnalysisModalLabel">
                        <i class="bi bi-robot me-2"></i>AI SLA Breach Analysis
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div class="text-center py-4" id="analysisLoading">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Analyzing...</span>
                        </div>
                        <p class="text-muted mb-0">AI is analyzing the ticket...</p>
                    </div>

                    <!-- Analysis Result -->
                    <div class="d-none" id="analysisResult">
                        <!-- Ticket Info -->
                        <div class="mb-4">
                            <label class="text-muted small">Ticket</label>
                            <p class="fw-medium mb-0" id="analysisTicketId"></p>
                            <p class="text-truncate mb-0" id="analysisTicketSubject"></p>
                        </div>

                        <!-- SLA Breach Percentage -->
                        <div class="text-center mb-4">
                            <label class="text-muted small d-block mb-2">SLA Breach Probability</label>
                            <div class="position-relative d-inline-block">
                                <div class="sla-gauge">
                                    <svg viewBox="0 0 120 120" width="120" height="120">
                                        <circle cx="60" cy="60" r="54" fill="none" stroke="#e9ecef" stroke-width="12"/>
                                        <circle cx="60" cy="60" r="54" fill="none" stroke-width="12" stroke-linecap="round"
                                            id="slaGaugeCircle"
                                            stroke="#28a745"
                                            stroke-dasharray="339.292"
                                            stroke-dashoffset="339.292"
                                            transform="rotate(-90 60 60)"/>
                                    </svg>
                                    <div class="sla-gauge-value">
                                        <span id="slaPercentage" class="fs-2 fw-bold">0</span>
                                        <span class="fs-6">%</span>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-2 mb-0" id="slaRiskLevel">
                                <span class="badge bg-success">Low Risk</span>
                            </p>
                        </div>

                        <!-- AI Analysis Details -->
                        <div class="mb-4">
                            <label class="text-muted small">AI Analysis</label>
                            <p class="mb-0" id="analysisDetails">Based on similar tickets and current workload, this ticket has a low probability of breaching its SLA.</p>
                        </div>

                        <!-- Feedback Section -->
                        <div class="border-top pt-3">
                            <label class="form-label fw-medium">
                                <i class="bi bi-chat-left-quote me-1"></i>
                                Was this prediction accurate?
                            </label>
                            <div class="d-flex gap-3" id="feedbackOptions">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="feedbackAccuracy" id="feedbackYes" value="yes">
                                    <label class="form-check-label" for="feedbackYes">
                                        <i class="bi bi-hand-thumbs-up me-1 text-success"></i> Yes, accurate
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="feedbackAccuracy" id="feedbackNo" value="no">
                                    <label class="form-check-label" for="feedbackNo">
                                        <i class="bi bi-hand-thumbs-down me-1 text-danger"></i> No, inaccurate
                                    </label>
                                </div>
                            </div>
                            <div class="d-none mt-3" id="feedbackSubmitted">
                                <div class="alert alert-success mb-0 py-2">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Thank you for your feedback! This helps improve our AI model.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div class="text-center py-4 d-none" id="analysisError">
                        <i class="bi bi-exclamation-circle text-danger fs-1 mb-3 d-block"></i>
                        <h5>Analysis Failed</h5>
                        <p class="text-muted mb-0" id="analysisErrorMessage">Unable to analyze this ticket. Please try again.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary d-none" id="submitFeedbackBtn">
                        <i class="bi bi-send me-1"></i> Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App Scripts -->
    <!-- Main app initialization (handles sidebar, navbar, user info) -->
    <script type="module" src="/assets/js/app.js"></script>
    
    <!-- Page-specific scripts -->
    <script type="module">
        import { initAIInsightsPage } from '/assets/js/pages/ai-insights.js';
        
        // Wait for app to be ready before initializing page
        document.addEventListener('app:ready', () => {
            console.log('[AI Insights] App ready, initializing page...');
            initAIInsightsPage();
        });
        
        // Fallback: also listen to DOMContentLoaded in case app:ready already fired
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Wait a bit to give app.js time to initialize
                setTimeout(() => {
                    if (!document.querySelector('.ai-insights-page-initialized')) {
                        console.log('[AI Insights] Initializing from DOMContentLoaded...');
                        initAIInsightsPage();
                    }
                }, 100);
            });
        }
    </script>

    <style>
        /* SLA Gauge Styles */
        .sla-gauge {
            position: relative;
            display: inline-block;
        }
        .sla-gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .sla-gauge svg {
            transform: rotate(0deg);
        }
    </style>
</body>
</html>
