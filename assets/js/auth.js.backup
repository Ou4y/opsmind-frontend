/**
 * OpsMind - Authentication Page Module
 * 
 * Handles the login page functionality:
 * - Form validation
 * - Authentication API call
 * - Error handling
 * - Password visibility toggle
 */

import AuthService from '/services/authService.js';

/**
 * Initialize the login page
 */
function initLoginPage() {
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const cardWrapper = document.querySelector('.login-card-wrapper');
    const showSignupBtn = document.getElementById('showSignup');
    const showLoginBtn = document.getElementById('showLogin');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const toggleSignupPasswordBtn = document.getElementById('toggleSignupPassword');
    const loginButton = document.getElementById('loginButton');
    const signupButton = document.getElementById('signupButton');
    const loginError = document.getElementById('loginError');
    const loginErrorMessage = document.getElementById('loginErrorMessage');
    const signupError = document.getElementById('signupError');
    const signupErrorMessage = document.getElementById('signupErrorMessage');

    // Check if already authenticated
    if (AuthService.isAuthenticated()) {
        window.location.href = 'dashboard.html';
        return;
    }

    /**
     * Toggle between Sign In and Sign Up forms
     */
    showSignupBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        cardWrapper?.classList.add('flipped');
        hideError();
        hideSignupError();
    });

    showLoginBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        cardWrapper?.classList.remove('flipped');
        hideError();
        hideSignupError();
    });

    /**
     * Toggle password visibility for login
     */
    togglePasswordBtn?.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Toggle icon
        const icon = togglePasswordBtn.querySelector('i');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
    });

    /**
     * Toggle password visibility for signup
     */
    toggleSignupPasswordBtn?.addEventListener('click', () => {
        const signupPasswordInput = document.getElementById('signupPassword');
        const type = signupPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        signupPasswordInput.setAttribute('type', type);
        
        // Toggle icon
        const icon = toggleSignupPasswordBtn.querySelector('i');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
    });

    /**
     * Show error message
     */
    function showError(message) {
        loginErrorMessage.textContent = message;
        loginError.classList.remove('d-none');
        
        // Shake animation
        loginError.classList.add('shake');
        setTimeout(() => loginError.classList.remove('shake'), 500);
    }

    /**
     * Hide error message
     */
    function hideError() {
        loginError.classList.add('d-none');
    }

    /**
     * Show signup error message
     */
    function showSignupError(message) {
        signupErrorMessage.textContent = message;
        signupError.classList.remove('d-none');
        
        // Shake animation
        signupError.classList.add('shake');
        setTimeout(() => signupError.classList.remove('shake'), 500);
    }

    /**
     * Hide signup error message
     */
    function hideSignupError() {
        signupError.classList.add('d-none');
    }

    /**
     * Set loading state on login button
     */
    function setLoading(loading) {
        const btnText = loginButton.querySelector('.btn-text');
        const btnLoader = loginButton.querySelector('.btn-loader');
        
        if (loading) {
            loginButton.disabled = true;
            btnText.classList.add('d-none');
            btnLoader.classList.remove('d-none');
        } else {
            loginButton.disabled = false;
            btnText.classList.remove('d-none');
            btnLoader.classList.add('d-none');
        }
    }

    /**
     * Set loading state on signup button
     */
    function setSignupLoading(loading) {
        const btnText = signupButton.querySelector('.btn-text');
        const btnLoader = signupButton.querySelector('.btn-loader');
        
        if (loading) {
            signupButton.disabled = true;
            btnText.classList.add('d-none');
            btnLoader.classList.remove('d-none');
        } else {
            signupButton.disabled = false;
            btnText.classList.remove('d-none');
            btnLoader.classList.add('d-none');
        }
    }

    /**
     * Validate email format
     */
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    /**
     * Handle form submission
     */
    loginForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const rememberMe = document.getElementById('rememberMe')?.checked || false;

        // Client-side validation
        if (!email) {
            showError('Please enter your email address.');
            emailInput.focus();
            return;
        }

        if (!isValidEmail(email)) {
            showError('Please enter a valid email address.');
            emailInput.focus();
            return;
        }

        if (!password) {
            showError('Please enter your password.');
            passwordInput.focus();
            return;
        }

        if (password.length < 4) {
            showError('Password must be at least 4 characters.');
            passwordInput.focus();
            return;
        }

        // Attempt login
        setLoading(true);

        try {
            await AuthService.login(email, password, rememberMe);
            
            // Redirect to dashboard or intended page
            const redirectUrl = sessionStorage.getItem('opsmind_redirect');
            sessionStorage.removeItem('opsmind_redirect');
            
            if (redirectUrl && !redirectUrl.includes('index.html')) {
                window.location.href = redirectUrl;
            } else {
                window.location.href = 'dashboard.html';
            }
        } catch (error) {
            setLoading(false);
            
            // Handle specific error types
            if (error.message.includes('Invalid credentials')) {
                showError('Invalid email or password. Please try again.');
            } else if (error.message.includes('Network') || error.message.includes('fetch')) {
                showError('Unable to connect to the server. Please check your connection.');
            } else {
                showError(error.message || 'An error occurred. Please try again.');
            }
        }
    });

    /**
     * Handle signup form submission
     */
    signupForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideSignupError();

        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const accountType = document.querySelector('input[name="accountType"]:checked')?.value;
        const agreeTerms = document.getElementById('agreeTerms').checked;

        // Client-side validation
        if (!firstName) {
            showSignupError('Please enter your first name.');
            document.getElementById('firstName').focus();
            return;
        }

        if (!lastName) {
            showSignupError('Please enter your last name.');
            document.getElementById('lastName').focus();
            return;
        }

        if (!email) {
            showSignupError('Please enter your email address.');
            document.getElementById('signupEmail').focus();
            return;
        }

        if (!isValidEmail(email)) {
            showSignupError('Please enter a valid email address.');
            document.getElementById('signupEmail').focus();
            return;
        }

        if (!password) {
            showSignupError('Please enter a password.');
            document.getElementById('signupPassword').focus();
            return;
        }

        if (password.length < 8) {
            showSignupError('Password must be at least 8 characters.');
            document.getElementById('signupPassword').focus();
            return;
        }

        if (password !== confirmPassword) {
            showSignupError('Passwords do not match.');
            document.getElementById('confirmPassword').focus();
            return;
        }

        if (!accountType) {
            showSignupError('Please select an account type.');
            return;
        }

        if (!agreeTerms) {
            showSignupError('You must agree to the terms and conditions.');
            return;
        }

        // Attempt signup
        setSignupLoading(true);

        try {
            // In a real app, this would call AuthService.signup()
            // For demo, we'll simulate a successful signup
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const fullName = `${firstName} ${lastName}`;
            const accountTypeLabel = accountType.charAt(0).toUpperCase() + accountType.slice(1);
            
            // Show success message
            alert(`Account created successfully!\n\nName: ${fullName}\nEmail: ${email}\nAccount Type: ${accountTypeLabel}\n\nYou can now sign in.`);
            
            // Switch back to login form
            cardWrapper?.classList.remove('flipped');
            signupForm.reset();
            
            // Pre-fill email in login form
            emailInput.value = email;
            
        } catch (error) {
            setSignupLoading(false);
            showSignupError(error.message || 'An error occurred. Please try again.');
        } finally {
            setSignupLoading(false);
        }
    });

    /**
     * Clear error on input change
     */
    emailInput?.addEventListener('input', hideError);
    passwordInput?.addEventListener('input', hideError);

    /**
     * Handle Enter key on password field
     */
    passwordInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginForm?.requestSubmit();
        }
    });

    // Focus on email input on page load
    emailInput?.focus();
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initLoginPage);

// Add shake animation CSS if not present
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .shake { animation: shake 0.5s ease-in-out; }
`;
document.head.appendChild(style);
